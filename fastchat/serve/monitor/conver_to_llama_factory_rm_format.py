"""
Each data instance from like:
{
    "question_id": "abbdc95e296d4a4b85a3d1f030768719",
    "model_a": "gemini-pro",
    "model_b": "claude-2.1",
    "winner": "model_b",
    "judge": "arena_user_2606:40:1b32:1c3d::e66:99d5",
    "conversation_a": [
      {
        "role": "user",
        "content": "如果原本應該加95的車，加油加了92，會怎麼樣？"
      },
      {
        "role": "assistant",
        "content": "如果原本應該加95的車，加油加了92，可能會發生以下情況：\n\n* **引擎爆震（Knocking）：** 92號汽油的辛烷值較低，當它在高壓縮比的引擎中燃燒時，可能更容易發生爆震。爆震會導致引擎發出敲擊聲，並可能損壞引擎內部零件，例如活塞和連桿。\n* **動力下降：** 92號汽油的熱值較低，這意味著它在燃燒時產生的能量較少。因此，使用92號汽油的車輛可能會出現動力下降的情況。\n* **油耗增加：** 由於92號汽油的熱值較低，因此需要更多的汽油才能產生相同的動力。這可能會導致油耗增加。\n* **排放增加：** 92號汽油的燃燒可能會產生更多的排放，包括一氧化碳、碳氫化合物和氮氧化物。這些排放物會污染環境，並對人體健康造成危害。\n\n需要注意的是，以上情況的嚴重程度可能會因車輛的具體型號和狀況而異。有些車輛可能對92號汽油的使用比較敏感，而有些車輛則可能沒有明顯的影響。如果您的車輛原本應該加95號汽油，但您不小心加了92號汽油，最好儘快找專業人員進行檢修，以確定是否對車輛造成了損壞。"
      },
      {
        "role": "user",
        "content": "那如果加錯，可以利用加98來稀釋嗎？"
      },
      {
        "role": "assistant",
        "content": "如果不小心加錯汽油，可以使用加98來稀釋。但是，需要注意以下幾點：\n\n* **稀釋比例：** 98號汽油的辛烷值較高，因此需要按照一定的比例與92號汽油混合才能達到95號汽油的辛烷值。一般來說，92號汽油和98號汽油的混合比例為1:1。也就是說，如果油箱中還有半箱92號汽油，那麼需要添加半箱98號汽油才能達到95號汽油的辛烷值。\n* **稀釋後辛烷值：** 混合後的汽油辛烷值並不一定是95號。這取決於混合比例和所用汽油的具體辛烷值。因此，在混合汽油之前，最好先查閱汽油桶上的標籤，以確定汽油的具體辛烷值。\n* **稀釋後油耗：** 混合汽油的油耗可能會略微增加。這是因為98號汽油的熱值較高，因此需要更多的汽油才能產生相同的動力。\n* **稀釋後排放：** 混合汽油的排放可能會略微減少。這是因為98號汽油的燃燒更完全，因此會產生更少的排放物。\n\n需要注意的是，稀釋汽油只能作為一種臨時解決方案。如果您不小心加錯汽油，最好儘快找專業人員進行檢修，以確定是否對車輛造成了損壞。\n\n另外，有些車輛可能對汽油的辛烷值非常敏感，因此即使是少量加錯汽油也可能導致問題。如果您不確定您的車輛是否能夠承受汽油辛烷值的變化，最好不要嘗試稀釋汽油。"
      }
    ],
    "conversation_b": [
      {
        "role": "user",
        "content": "如果原本應該加95的車，加油加了92，會怎麼樣？"
      },
      {
        "role": "assistant",
        "content": "如果原本應該加95無鉛汽油的車,加了92無鉛汽油,可能會有以下幾個影響:\n\n1. 發動機馬力略為下降。95無鉛汽油的辛烷值較高,可以使發動機的燃燒更為充分,發揮較大馬力。用92無鉛汽油可能會使部分馬力無法發揮。\n\n2. 加速性稍差。同樣因為92無鉛汽油使發動機燃燒效率降低了一些,動力輸出會略為下降,導致加速時感覺稍慢。\n\n3. 油耗可能略為增加。發動機燃燒不充分,也會浪費一些燃料,所以油耗效率會略微下降一些。\n\n4. 長期使用有損發動機。如果長期使用較低等級的汽油,可能會增加發動機的碳化情形,縮短發動機壽命。\n\n但是只加滿一箱92無鉛汽油不會對發動機造成立即或嚴重的損害。待油箱加滿後再改用正確的95無鉛汽油即可。除非長期使用不符合需求的汽油等級,發動機才會受到更嚴重的影響。"
      },
      {
        "role": "user",
        "content": "那如果加錯，可以利用加98來稀釋嗎？"
      },
      {
        "role": "assistant",
        "content": "可以,如果加錯汽油等級,可以透過加注較高等級的汽油來稀釋和提高汽油的整體辛烷值。\n\n如果原本應該加95無鉛汽油卻加了92的,之後再加一些98無鉛汽油進去,可以使油箱內汽油的辛烷值稍微提高,比較接近95無鉛汽油的標準。這樣可以減少對發動機的影響。\n\n但是要注意的是,不要加太多98無鉛,只需要少量即可達到稀釋提升辛烷值的效果。如果全加98無鉛,對某些發動機而言辛烷值又太高,也會有問題。\n\n所以當加錯汽油時,加一些較高等級的汽油稀釋是可行的,但要掌握適量原則,同時盡快加滿正確汽油更換也很重要。"
      }
    ],
    "turn": 2,
    "anony": true,
    "language": "Chinese",
    "tstamp": 1705197743.088
}
to like:
{
    "instruction": "那如果加錯，可以利用加98來稀釋嗎？",
    "input": "",
    "output": [
      "可以,如果加錯汽油等級,可以透過加注較高等級的汽油來稀釋和提高汽油的整體辛烷值。\n\n如果原本應該加95無鉛汽油卻加了92的,之後再加一些98無鉛汽油進去,可以使油箱內汽油的辛烷值稍微提高,比較接近95無鉛汽油的標準。這樣可以減少對發動機的影響。\n\n但是要注意的是,不要加太多98無鉛,只需要少量即可達到稀釋提升辛烷值的效果。如果全加98無鉛,對某些發動機而言辛烷值又太高,也會有問題。\n\n所以當加錯汽油時,加一些較高等級的汽油稀釋是可行的,但要掌握適量原則,同時盡快加滿正確汽油更換也很重要。",
      "如果不小心加錯汽油，可以使用加98來稀釋。但是，需要注意以下幾點：\n\n* **稀釋比例：** 98號汽油的辛烷值較高，因此需要按照一定的比例與92號汽油混合才能達到95號汽油的辛烷值。一般來說，92號汽油和98號汽油的混合比例為1:1。也就是說，如果油箱中還有半箱92號汽油，那麼需要添加半箱98號汽油才能達到95號汽油的辛烷值。\n* **稀釋後辛烷值：** 混合後的汽油辛烷值並不一定是95號。這取決於混合比例和所用汽油的具體辛烷值。因此，在混合汽油之前，最好先查閱汽油桶上的標籤，以確定汽油的具體辛烷值。\n* **稀釋後油耗：** 混合汽油的油耗可能會略微增加。這是因為98號汽油的熱值較高，因此需要更多的汽油才能產生相同的動力。\n* **稀釋後排放：** 混合汽油的排放可能會略微減少。這是因為98號汽油的燃燒更完全，因此會產生更少的排放物。\n\n需要注意的是，稀釋汽油只能作為一種臨時解決方案。如果您不小心加錯汽油，最好儘快找專業人員進行檢修，以確定是否對車輛造成了損壞。\n\n另外，有些車輛可能對汽油的辛烷值非常敏感，因此即使是少量加錯汽油也可能導致問題。如果您不確定您的車輛是否能夠承受汽油辛烷值的變化，最好不要嘗試稀釋汽油。"
    ],
    "history": [
      [
        "如果原本應該加95的車，加油加了92，會怎麼樣？",
        "如果原本應該加95無鉛汽油的車,加了92無鉛汽油,可能會有以下幾個影響:\n\n1. 發動機馬力略為下降。95無鉛汽油的辛烷值較高,可以使發動機的燃燒更為充分,發揮較大馬力。用92無鉛汽油可能會使部分馬力無法發揮。\n\n2. 加速性稍差。同樣因為92無鉛汽油使發動機燃燒效率降低了一些,動力輸出會略為下降,導致加速時感覺稍慢。\n\n3. 油耗可能略為增加。發動機燃燒不充分,也會浪費一些燃料,所以油耗效率會略微下降一些。\n\n4. 長期使用有損發動機。如果長期使用較低等級的汽油,可能會增加發動機的碳化情形,縮短發動機壽命。\n\n但是只加滿一箱92無鉛汽油不會對發動機造成立即或嚴重的損害。待油箱加滿後再改用正確的95無鉛汽油即可。除非長期使用不符合需求的汽油等級,發動機才會受到更嚴重的影響。"
      ]
    ]
}

"instruction" is last user turn
"output"[0] is the winner last response
"history": take the winner's history

Can keep the unrelated key
"""
import argparse
import json
import json
from datasets import Dataset, DatasetDict, load_dataset


def convert_format(input_file, output_file):
    with open(input_file, 'r') as f:
        data = json.load(f)

    new_data = []
    for item in data:
        if "winner" in item and item["winner"] in ["model_a", "model_b"]:
            assert len(item["conversation_a"]) == len(item["conversation_b"]) 
            assert not len(item["conversation_a"]) % 2
            instruction = item["conversation_a"][-2]['content']
            assert item["conversation_a"][-2]['role'] == 'user'
            output_a = item["conversation_a"][-1]['content']
            output_b = item["conversation_b"][-1]['content']
            if not isinstance(output_a, str) or not isinstance(output_b, str) or not output_a or not output_b:
                continue
            if item["winner"] == "model_a":
                history = [conv['content'] for conv in item["conversation_a"][:-2]]
                output = [output_a, output_b]
            else:
                history = [conv['content'] for conv in item["conversation_b"][:-2]]
                output = [output_b, output_a]
            assert not len(history) % 2
            paired_history = []
            for i in range(0, len(history), 2):
                paired_history.append([history[i], history[i+1]])
            assert instruction.strip()
            
            new_item = {
                "instruction": instruction,
                "input": "",
                "output": output,
                "history": paired_history
            }
            new_data.append(new_item)

    # 計算並列印一些統計資料
    total_items = len(new_data)
    total_instructions = sum(1 for item in new_data if item["instruction"].strip())
    total_outputs = sum(len(item["output"]) for item in new_data)
    total_history_entries = sum(len(item["history"]) for item in new_data)

    print(f"總共轉換項目數量: {total_items}")
    print(f"包含指令的項目數量: {total_instructions}")
    print(f"總輸出數量: {total_outputs}")
    print(f"歷史記錄總條目數量: {total_history_entries}")

    data = Dataset.from_list(new_data)
    data.push_to_hub("yentinglin/chatbot_arena_conversations", private=True)

    with open(output_file, 'w') as f:
        json.dump(new_data, f, ensure_ascii=False, indent=4)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--input", type=str, help="Input file path")
    parser.add_argument("--output", type=str, help="Output file path")
    args = parser.parse_args()

    convert_format(args.input, args.output)
